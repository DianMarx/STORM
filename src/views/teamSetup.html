<!DOCTYPE html>
<html>
<script src="APIs/jquery-2.1.4.min.js"></script>
<head lang="en">
    <meta charset="UTF-8">
    <title>Team Setup</title>

    <link rel="stylesheet" href="APIs/jquery-ui-1.11.4.custom/jquery-ui.min.css">
    <script src="APIs/jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
    <script src="APIs/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="style/css.css">

    <script src="scripts/dbInteraction.js"></script>

    <style>
        section {
            width: 80%;
                height: 500px;
                background:#333;
                margin: auto;
                padding: 10px;
            }

        .minusButton{
            float:right;
            opacity: 0;

            -webkit-transition: opacity 0.5s ease-in-out;
            -moz-transition: opacity 0.5s ease-in-out;
            -ms-transition: opacity 0.5s ease-in-out;
            -o-transition: opacity 0.5s ease-in-out;
            transition: opacity 0.5s ease-in-out;
        }

        .teamTables:hover .minusButton{
            opacity: 100;
        }
	</style>

    <script>

        var numTeamGroups = 3; //Including add div, so technically numTeamGroups-1 droppable groups.

        $(document).ready(function(e) {

			$('#randomize').click(function(e) {
				var max = 5;
                //var i = $('.names').children().length;
				//alert("yooo");
				$('.names').children().each(function(index, element) {
                    var randm = Math.floor(Math.random() * (4-1) + 1);
					//alert(randm);
					var done = false;
					while(done != true){
					switch(randm){
					case 1:if($('.first').children().length < max){
					 $(element).appendTo(".first"); done = true; 
					 if($('.first').children().length == max) max = 4;
					 break;} else max = 4;
					case 2: if($('.second').children().length < max){
					 $(element).appendTo(".second"); done = true; 
					 if($('.second').children().length == max) max = 4;
					 break;}else  max = 4; 
					case 3: if($('.third').children().length < max){
					 $(element).appendTo(".third");done = true;
					 if($('.third').children().length == max) max = 4;
					  break;}else max = 4;
					  }
					  randm = Math.floor(Math.random() * (4-1) + 1);
					}
                });
            });

            $("#plusButton").click(function(e){
                if(numTeamGroups % 3 == 0 && numTeamGroups != 0) {
                    $("<div class='teamTables "+(numTeamGroups)+"' ondrop='drop(event)' ondragover='allowDrop(event)'><img src='images/minus_button.png' class='minusButton mB"+(numTeamGroups)+"' alt='minus' height='25' width='25'></div>").insertBefore($("#teamAdd"));
                    $("<br><br>").insertBefore($("#teamAdd"));
                    numTeamGroups++;
                }
                else{
                    $("<div class='teamTables "+(numTeamGroups)+"' ondrop='drop(event)' ondragover='allowDrop(event)'><img src='images/minus_button.png' class='minusButton mB"+(numTeamGroups)+"' alt='minus' height='25' width='25'></div>").insertBefore($("#teamAdd"));
                    numTeamGroups++;
                }

                $(".minusButton").off();

                $(".minusButton").on("click", function(e){
                    var parent = $(this).parent();
                    if (parent.find("div").length >= 1){
                        fnOpenNormalDialog($(this));
                    }
                    else
                    {
                        confirmDeleteTeamTable($(this));
                    }
                });
            });

            $(".minusButton").on("click", function(e){
                var parent = $(this).parent();
                if (parent.find("div").length >= 1){
                    fnOpenNormalDialog($(this));
                }
                else
                {
                    confirmDeleteTeamTable($(this));
                }
            });
        });




        function fnOpenNormalDialog(element) {
            $("#dialog-confirm").html("Are you sure you want to delete this team box?<br>Subjects will be returned to spawn pool.");

            // Define the Dialog and its properties.
            $("#dialog-confirm").dialog({
                resizable: false,
                modal: true,
                title: "Confirm delete",
                height: 250,
                width: 400,
                buttons: {
                    "Yes": function () {
                        $(this).dialog('close');
                        confirmDeleteTeamTable(element);
                    },
                    "No": function () {
                        $(this).dialog('close');
                    }
                }
            });
        }

        function confirmDeleteTeamTable(element)
        {
            var boxID = element.attr('class');
            boxID = boxID.replace("minusButton mB", "");

            numTeamGroups--;

            $(".teams br").remove();

            $("."+boxID).find("div").each(function(){
                $(".names").append($(this));
            });

            $("."+boxID).remove();

            var i = 0;
            var fromHere = false;
            $(".teams").find(".teamTables").each(function(){
                i++;
                if (i % 3 == 0)
                {
                    $("<br/><br/>").insertAfter($(this));
                }

                if ((i) == boxID)
                    fromHere = true;

                if (fromHere)
                {
                    $(this).removeClass((i+1).toString());
                    $(this).addClass(boxID.toString());
                    $(this).children(".minusButton").removeClass("mB"+(i+1).toString());
                    $(this).children(".minusButton").addClass("mB"+boxID.toString());
                    boxID++;
                }
            });
        }
	
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(data));
        }

        $(function() {
            $( "input[type=submit], a, button, input[type=file]" ).button();

            $( "#dialog" ).dialog({
                autoOpen: false,
                width: 400,
                buttons: [
                    {
                        text: "Ok",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ]
            });;
        });

        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }
	
    </script>
</head>
<body>
    <div class="header">
        <h2 class="headerMessages">Team Setup</h2>
        <img id="logo" src="images/Storm.png" alt="STORM Logo" height="80" />

    </div>
    <div class="main">
        <div class="teamSetup">
            <div class="members">
                <div id="subjects" class="names" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <%for(var i = 0; i < subjects.length; i++){%>
                    <div class="subject" id=<%= i %> draggable="true" ondragstart="drag(event)"><%=subjects[i].name%>
                    </div> <% } %>
                </div>
                Import from .CSV file: <input type="file" id="CSVInput" name="file" accept=".csv"/>
            </div>

            <button name="Randomize" id="randomize">Randomize</button>

            <div class="teams">


                <div class="teamTables 1" ondrop="drop(event)" ondragover="allowDrop(event)"><img src="images/minus_button.png" class="minusButton mB1" alt="plus" height="25" width="25"></div>
                <div class="teamTables 2" ondrop="drop(event)" ondragover="allowDrop(event)"><img src="images/minus_button.png" class="minusButton mB2" alt="plus" height="25" width="25"></div>
                <div class="teamAdd" id="teamAdd" ondrop="drop(event)"><img src="images/plus_button.png" id="plusButton" alt="plus" height="42" width="42"></div>
            </div>
        </div>
    </div>

    <div id="dialog" title="Basic dialog">
        <div id="dialogText"></div>
    </div>

    <br>
    <div id="dialog-confirm"></div>

</body>
<script src="scripts/inputCSV.js"></script>
<script>
</script>
</html>