<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>STORM Projects</title>

    <link rel="stylesheet" href="style/css.css">
    <link rel="stylesheet" href="APIs/jquery-ui-1.11.4.custom/jquery-ui.min.css">
    <script src="APIs/jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
    <script src="APIs/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>

    <script>
        var Subjects;

        function AddProjectToDB(Sub)
        {

        }

        function UploadCSV()
        {
            document.getElementById("CSVInput").onchange = function(e){
                alert("yay");
                var myFileInput = document.getElementById('CSVInput');
                var myFile = myFileInput.files[0];

                var file = document.getElementById('CSVInput').files[0];
                if (file) {
                    // create reader
                    var reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = function(e) {
                        alert("yay");
                        var result = e.target.result;   // browser completed reading file
                        $("#dialog-confirm").html("Successfully read the contents of the file.");

                        // Define the Dialog and its properties.
                        $("#dialog-confirm").dialog({
                            resizable: false,
                            modal: true,
                            title: "Success",
                            height: 250,
                            width: 400,
                            buttons: {
                                "Ok": function () {
                                    $(this).dialog('close');
                                }
                            },
                            show: { effect: "scale", duration: 250 },
                            hide: { effect: "scale", duration: 250 }
                        });

                        var arrayOfTheInput = result.split("\r\n");       //Splits the values from file into array
                        var headings = arrayOfTheInput[0].split(",");

                        var JSONObject = []; //Hierdie is die JSON object wat in die DB gestoor gaan word.

                        for(i = 1; i < arrayOfTheInput.length-1; i++)
                        {
                            var line = arrayOfTheInput[i].split(",");

                            tempObj = {};
                            for (var k = 0; k < headings.length; k++)
                            {
                                if (typeof line[k] == 'undefined')
                                {
                                    tempObj[headings[k]] = "";
                                }
                                else
                                    tempObj[headings[k]] = line[k];
                            }
                            JSONObject.push(tempObj);
                        }
                        Subjects = JSON.stringify(JSONObject);

                        //alert(JSON.stringify(JSONObject));
                    };
                }
            }
        }

        $(document).ready(function(e) {

            $("#AddProjectsImg").click(function(){
                $("#AddProjects").html( '<div id="AddProjectDetails">' +
                                            '<form>' +
                                                'Project Name: <br/><input type="text" name="projectName"><br/><br/>' +
                                                'Import subjects from .CSV file: <br/><input type="file" id="CSVInput" name="file" accept=".csv"/>' +
                                                '<input type="button" value="Add Project" id="AddProject">' +
                                            '</form>' +
                                        '</div>');
                $( "input[type=submit], button, input[type=file]" ).button();
                $("#CSVInput").onclick = UploadCSV();
                $("#AddProject").onclick = AddProjectToDB();
            });

            $("#AddProjectsImg").hover(
                    function(){$(this).animate({width: 150, height:150}, 500);},
                    function(){$(this).animate({width: 100, height:100}, 300);}
            );

            if (sessionStorage.length == 0) // no user logged on.
            {
                alert("Please log in");
                window.location.href = "/";

                $("#errorDialog").html("You are not logged in. <br> Please go back and log in or sign up. ");
                $("#errorDialog").dialog({
                    resizable: false,
                    modal: true,
                    title: "Error",
                    height: 250,
                    width: 400,
                    buttons: {
                        "Ok": function () {
                            $(this).dialog('close');
                             //return to login
                        }
                    }
                });
            }
            else { //user is logged on.

                $('.loader').html('<img src="images/loader.gif"><br/> Loading Projects...');
                var user = JSON.parse(sessionStorage['User']);
                var projectIDs = JSON.stringify(user.projectID);
                $("#user").text("User: " + user.username);

                //send project ids to server and get projects related to a user
                $.ajax({
                    type: "POST",
                    url: '/projectSetup',
                    data: {"ids" : projectIDs},
                    dataType: "json",
                    success: function (dat, testStatus) {

                        var data = JSON.stringify(dat);
                        var displayProjects = "";
                        for(var i = 0; i < dat.length; i++)
                        {
                            displayProjects += '<div><a class="projLink" href="#">'+dat[i].projectName+'</a></div><br/>';
                        }
                        $("#Projects").html(displayProjects);

                    },

                    error: function(e)
                    {
                        console.log(e);
                    }
                });
            }



        });

    </script>
</head>
<body>
<div class="header">
    <h2 class="headerMessages">Manage Projects</h2><br/>
    <h4 id="user"></h4>
    <img id="logo" src="images/Storm.png" alt="STORM Logo" height="80" />

</div>

<div class="main">

    <div class="background">
        <img src="../Images/Storm.png" style="width: 100%;top:auto;">
    </div>
    <div id="Projects" class="loader">
        <div id="ProjectsHead"><p id="projectHeadTxt">My Projects</p></div>
    </div>

    <div id="AddProjects" ><img id="AddProjectsImg" src="images/plus_button.png" height="100px"><br/>Add Projects</div>
    <div id="dialog-confirm"></div>

</div>
<footer class="footer">
    <div class="footerMenu">
        <table id="tableMenu">
            <tr id="tableMenu">
                <th id="tableMenu"><input id="homeButton" type="text" value="Home"
                                          onclick="window.location='/';" /></th>
                <th id="tableMenu"><input id="aboutButton" type="text" value="About"
                                          onclick="window.location='/about';" /></th>
                <th id="tableMenu"><input id="contactButton" type="text" value="Contact Us"
                                          onclick="window.location='/contact';" /></th>
            </tr>
        </table>
    </div>
</footer>





</body>
</html>